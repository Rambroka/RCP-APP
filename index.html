<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>RCP Timer Avan√ßado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #ea580c 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 130px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
        }

        .header-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
        }

        .status {
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .total-time {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .total-time h2 {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .total-time .time {
            font-size: 42px;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .mode-selector {
            background: rgba(0,0,0,0.25);
            border-radius: 15px;
            padding: 12px;
            margin: 15px 0;
            text-align: center;
        }

        .mode-selector h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .mode-btn:active {
            transform: scale(0.96);
        }

        .timers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .timer-card {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            border: 3px solid transparent;
            transition: border-color 0.2s;
        }

        .timer-card.alert {
            border-color: #fbbf24;
            animation: pulse 1s infinite;
        }

        .timer-card.inactive {
            opacity: 0.6;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .timer-time {
            font-size: 26px;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin-bottom: 4px;
        }

        .timer-subtitle {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .timer-card button {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .timer-card button:active {
            transform: scale(0.96);
        }

        .phase {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }

        .phase h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .phase-time {
            font-size: 32px;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin-bottom: 4px;
        }

        .phase-info {
            font-size: 13px;
            opacity: 0.8;
        }

        .shocks {
            background: rgba(0,0,0,0.25);
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
        }

        .shocks-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shocks-list {
            max-height: 180px;
            overflow-y: auto;
            margin: 8px 0 10px;
        }

        .shock-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .shock-main {
            flex: 1;
        }

        .shock-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .shock-interval {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 3px 6px;
            font-size: 11px;
        }

        .shocks-empty {
            font-size: 12px;
            opacity: 0.7;
            font-style: italic;
            padding: 10px 0;
            text-align: center;
        }

        .btn-shock {
            width: 100%;
            border-radius: 12px;
            padding: 8px;
            border: none;
            background: #facc15;
            color: #111827;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-shock:active {
            transform: scale(0.97);
        }

        .controls {
            position: fixed;
            inset-inline: 0;
            bottom: 0;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .controls-inner {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .controls-row {
            display: flex;
            gap: 8px;
        }

        .controls button {
            flex: 1;
            border: none;
            border-radius: 14px;
            padding: 10px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .controls button:active {
            transform: scale(0.96);
        }

        .btn-start { background: #16a34a; }
        .btn-pause { background: #ea580c; }
        .btn-next { background: #2563eb; }
        .btn-reset { background: #dc2626; }

        .hidden {
            display: none !important;
        }

        .alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .alert-box {
            background: #ffffff;
            color: #111827;
            border-radius: 18px;
            padding: 20px;
            max-width: 320px;
            margin: 0 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .alert-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 20px;
            color: #b91c1c;
        }

        .alert-box p {
            font-size: 14px;
            margin-bottom: 16px;
            white-space: pre-line;
        }

        .alert-box button {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .alert-box button:active {
            transform: scale(0.96);
        }

        .audio-settings {
            background: rgba(0,0,0,0.25);
            border-radius: 15px;
            padding: 12px;
            margin: 15px 0;
            font-size: 12px;
        }

        .audio-settings h4 {
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .audio-settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
        }

        .audio-settings input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .audio-settings button {
            margin-top: 8px;
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="header">
            <div class="header-icon">‚ù§Ô∏è</div>
            <h1>RCP Avan√ßado</h1>
            <div class="status" id="statusText">Pronto para iniciar</div>
        </div>

        <!-- Tempo total -->
        <div class="total-time">
            <h2>Tempo Total de RCP</h2>
            <div class="time" id="totalTime">00:00</div>
        </div>

        <!-- Seletor de Modo: Intubado / N√£o Intubado -->
        <div class="mode-selector">
            <h3>ü´Å Via A√©rea</h3>
            <div class="mode-buttons">
                <button class="mode-btn active" id="btnNotIntubated" onclick="app.setMode(false)">
                    N√£o Intubado (30:2)
                </button>
                <button class="mode-btn" id="btnIntubated" onclick="app.setMode(true)">
                    Intubado (Cont√≠nuo)
                </button>
            </div>
        </div>

        <!-- Timers de adrenalina e troca -->
        <div class="timers-grid">
            <div class="timer-card inactive" id="adrenalineCard">
                <div class="timer-title">üíâ Adrenalina</div>
                <div class="timer-time" id="adrenalineTime">--:--</div>
                <div class="timer-subtitle" id="adrenalineCount">0 doses</div>
                <button onclick="app.registerAdrenaline()">Aplicar 1¬™ dose</button>
            </div>

            <div class="timer-card inactive" id="massageCard">
                <div class="timer-title">üîÑ Troca de massagista</div>
                <div class="timer-time" id="massageTime">--:--</div>
                <div class="timer-subtitle" id="massageCount">0 trocas</div>
                <button onclick="app.changeMassager()">Registrar 1¬™ troca</button>
            </div>
        </div>

        <!-- Configura√ß√µes de √°udio -->
        <div class="audio-settings">
            <h4>üîä Configura√ß√µes de √Åudio</h4>
            <label>
                <input type="checkbox" id="audioEnabled" checked onchange="app.toggleAudio()">
                <span>Ativar comandos de voz</span>
            </label>
            <button onclick="app.testVoice()">Testar voz</button>
        </div>

        <!-- Fase atual -->
        <div class="phase" id="phaseBox">
            <h3 id="phaseName">Compress√µes (30x)</h3>
            <div class="phase-time" id="phaseTime">00:00</div>
            <div class="phase-info" id="phaseInfo">Ciclo 1 ‚Ä¢ 0 compress√µes</div>
        </div>

        <!-- Choques -->
        <div class="shocks">
            <div class="shocks-header">
                <span>‚ö°</span>
                <span>Choques aplicados</span>
            </div>
            <div class="shocks-list" id="shockList">
                <div class="shocks-empty">Nenhum choque registrado</div>
            </div>
            <button class="btn-shock" onclick="app.registerShock()">‚ö° Registrar Choque</button>
        </div>
    </div>

    <!-- Controles fixos -->
    <div class="controls">
        <div class="controls-inner">
            <div class="controls-row" id="startRow">
                <button class="btn-start" onclick="app.start()">
                    ‚ñ∂Ô∏è Iniciar RCP
                </button>
            </div>
            <div class="controls-row hidden" id="runningRow">
                <button class="btn-pause" onclick="app.pause()">‚è∏Ô∏è Pausar</button>
                <button class="btn-next" onclick="app.nextPhase()" id="btnNextPhase">‚è≠Ô∏è Pr√≥xima fase</button>
            </div>
            <div class="controls-row">
                <button class="btn-reset" onclick="app.reset()">üîÑ Reiniciar</button>
            </div>
        </div>
    </div>

    <!-- Alerta -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-box">
            <h3>Aten√ß√£o!</h3>
            <p id="alertMessage"></p>
            <button onclick="app.closeAlert()">OK</button>
        </div>
    </div>

    <script>
        // Sistema de s√≠ntese de voz
        const voiceSystem = {
            enabled: true,
            synth: window.speechSynthesis,
            voice: null,

            init() {
                if (!this.synth) {
                    console.log('S√≠ntese de voz n√£o dispon√≠vel');
                    return;
                }

                const loadVoices = () => {
                    const voices = this.synth.getVoices();
                    this.voice = voices.find(v => v.lang === 'pt-BR') || 
                                 voices.find(v => v.lang.startsWith('pt')) ||
                                 voices[0];
                };

                loadVoices();
                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = loadVoices;
                }
            },

            speak(text, rate = 1.0, pitch = 1.0) {
                if (!this.enabled || !this.synth) return;

                this.synth.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = rate;
                utterance.pitch = pitch;
                utterance.volume = 1.0;

                if (this.voice) {
                    utterance.voice = this.voice;
                }

                this.synth.speak(utterance);
            },

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        };

        const app = {
            // Estados principais
            isRunning: false,
            isIntubated: false,  // NOVO: controla se √© paciente intubado
            totalTime: 0,
            phaseTime: 0,
            adrenalineTime: 0,
            massageChangeTime: 0,

            // Controle de ativa√ß√£o dos timers
            adrenalineActive: false,
            massageActive: false,

            // Contadores
            adrenalineCount: 0,
            massageChangeCount: 0,
            shocks: [],
            lastShockTime: 0,

            cycleCount: 0,
            compressionCount: 0,
            phaseIndex: 0,

            lastAdrenalineAlert: -999,
            lastMassageAlert: -999,

            timerHandle: null,

            phases: [
                { name: 'Compress√µes (30x)', duration: 18 },
                { name: 'Ventila√ß√µes (2x)', duration: 5 }
            ],

            // NOVA FUN√á√ÉO: Alterna entre intubado e n√£o intubado
            setMode(intubated) {
                this.isIntubated = intubated;

                // Atualiza bot√µes
                document.getElementById('btnNotIntubated').classList.toggle('active', !intubated);
                document.getElementById('btnIntubated').classList.toggle('active', intubated);

                // Esconde/mostra bot√£o "Pr√≥xima fase"
                const btnNextPhase = document.getElementById('btnNextPhase');
                if (intubated) {
                    btnNextPhase.style.display = 'none';
                } else {
                    btnNextPhase.style.display = 'flex';
                }

                // Feedback de voz
                if (this.isRunning) {
                    voiceSystem.speak(
                        intubated 
                            ? 'Modo intubado: compress√µes cont√≠nuas' 
                            : 'Modo padr√£o: ciclos 30 compress√µes e 2 ventila√ß√µes'
                    );
                }

                this.updateDisplay();
            },

            formatTime(sec) {
                const s = Math.floor(sec);
                const m = Math.floor(s / 60);
                const r = s % 60;
                return String(m).padStart(2, '0') + ':' + String(r).padStart(2, '0');
            },

            updateDisplay() {
                document.getElementById('totalTime').textContent = this.formatTime(this.totalTime);

                // Adrenalina
                if (this.adrenalineActive) {
                    document.getElementById('adrenalineTime').textContent = this.formatTime(this.adrenalineTime);
                } else {
                    document.getElementById('adrenalineTime').textContent = '--:--';
                }

                // Massagista
                if (this.massageActive) {
                    document.getElementById('massageTime').textContent = this.formatTime(this.massageChangeTime);
                } else {
                    document.getElementById('massageTime').textContent = '--:--';
                }

                document.getElementById('phaseTime').textContent = this.formatTime(this.phaseTime);

                // AJUSTE: Mostra fase diferente se intubado
                if (this.isIntubated) {
                    document.getElementById('phaseName').textContent = 'Compress√µes Cont√≠nuas';
                    document.getElementById('phaseInfo').textContent = 
                        `100/min ‚Ä¢ ${this.compressionCount} compress√µes`;
                } else {
                    const phase = this.phases[this.phaseIndex];
                    document.getElementById('phaseName').textContent = phase.name;
                    document.getElementById('phaseInfo').textContent =
                        `Ciclo ${this.cycleCount + 1} ‚Ä¢ ${this.compressionCount} compress√µes`;
                }

                const adrenalineCard = document.getElementById('adrenalineCard');
                const massageCard = document.getElementById('massageCard');

                // Alertas visuais
                if (this.adrenalineActive && this.adrenalineTime >= 180) {
                    adrenalineCard.classList.add('alert');
                } else {
                    adrenalineCard.classList.remove('alert');
                }

                if (this.massageActive && this.massageChangeTime >= 120) {
                    massageCard.classList.add('alert');
                } else {
                    massageCard.classList.remove('alert');
                }

                if (this.adrenalineActive) {
                    adrenalineCard.classList.remove('inactive');
                }
                if (this.massageActive) {
                    massageCard.classList.remove('inactive');
                }
            },

            tick() {
                this.totalTime += 0.1;
                this.phaseTime += 0.1;

                if (this.adrenalineActive) {
                    this.adrenalineTime += 0.1;
                }

                if (this.massageActive) {
                    this.massageChangeTime += 0.1;
                }

                // Alertas temporais
                if (this.adrenalineActive) {
                    const adrenalSec = Math.floor(this.adrenalineTime);
                    if (adrenalSec === 180 && adrenalSec !== this.lastAdrenalineAlert) {
                        this.lastAdrenalineAlert = adrenalSec;
                        voiceSystem.speak('Aplicar adrenalina', 0.9, 1.1);
                        this.showAlert('‚ö†Ô∏è ADRENALINA\n3 minutos desde a √∫ltima dose');
                    }
                }

                if (this.massageActive) {
                    const massageSec = Math.floor(this.massageChangeTime);
                    if (massageSec === 120 && massageSec !== this.lastMassageAlert) {
                        this.lastMassageAlert = massageSec;
                        voiceSystem.speak('Checar ritmo, trocar massagista', 0.9, 1.1);
                        this.showAlert('‚ö†Ô∏è TROCAR MASSAGISTA\n2 minutos de compress√£o cont√≠nua');
                    }
                }

                // AJUSTE: S√≥ avan√ßa fase automaticamente se N√ÉO for intubado
                if (!this.isIntubated) {
                    const currentPhase = this.phases[this.phaseIndex];
                    if (this.phaseTime >= currentPhase.duration) {
                        this.nextPhase(true);
                    }
                }

                this.updateDisplay();
            },

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                document.getElementById('statusText').textContent = 'RCP em andamento';
                document.getElementById('startRow').classList.add('hidden');
                document.getElementById('runningRow').classList.remove('hidden');

                if (this.timerHandle === null) {
                    this.timerHandle = setInterval(() => this.tick(), 100);
                }

                voiceSystem.speak('Iniciando RCP', 1.0, 1.0);
            },

            pause() {
                if (!this.isRunning) return;
                this.isRunning = false;
                document.getElementById('statusText').textContent = 'Pausado';

                document.getElementById('startRow').classList.remove('hidden');
                document.getElementById('runningRow').classList.add('hidden');

                if (this.timerHandle !== null) {
                    clearInterval(this.timerHandle);
                    this.timerHandle = null;
                }

                voiceSystem.speak('RCP pausada', 1.0, 1.0);
            },

            reset() {
                this.pause();

                this.totalTime = 0;
                this.phaseTime = 0;
                this.adrenalineTime = 0;
                this.massageChangeTime = 0;

                this.adrenalineActive = false;
                this.massageActive = false;

                this.adrenalineCount = 0;
                this.massageChangeCount = 0;
                this.shocks = [];
                this.lastShockTime = 0;

                this.cycleCount = 0;
                this.compressionCount = 0;
                this.phaseIndex = 0;

                this.lastAdrenalineAlert = -999;
                this.lastMassageAlert = -999;

                document.getElementById('adrenalineCount').textContent = '0 doses';
                document.getElementById('massageCount').textContent = '0 trocas';
                document.getElementById('statusText').textContent = 'Pronto para iniciar';

                const adrenalineCard = document.getElementById('adrenalineCard');
                const massageCard = document.getElementById('massageCard');
                adrenalineCard.classList.add('inactive');
                massageCard.classList.add('inactive');
                adrenalineCard.querySelector('button').textContent = 'Aplicar 1¬™ dose';
                massageCard.querySelector('button').textContent = 'Registrar 1¬™ troca';

                this.renderShocks();
                this.updateDisplay();
            },

            nextPhase(auto = false) {
                // Ignora se for intubado
                if (this.isIntubated) return;

                this.phaseIndex = (this.phaseIndex + 1) % this.phases.length;
                this.phaseTime = 0;

                if (this.phaseIndex === 0) {
                    this.cycleCount++;
                    this.compressionCount += 30;
                }

                if (!auto) {
                    const phaseName = this.phases[this.phaseIndex].name;
                    voiceSystem.speak(phaseName, 1.0, 1.0);
                    this.showAlert(`Fase alterada para: ${phaseName}`);
                }

                this.updateDisplay();
            },

            registerAdrenaline() {
                if (!this.adrenalineActive) {
                    this.adrenalineActive = true;
                }

                this.adrenalineCount++;
                this.adrenalineTime = 0;
                this.lastAdrenalineAlert = -999;

                document.getElementById('adrenalineCount').textContent =
                    `${this.adrenalineCount} dose${this.adrenalineCount > 1 ? 's' : ''}`;

                document.querySelector('#adrenalineCard button').textContent = 'Registrar dose';

                voiceSystem.speak('Adrenalina aplicada', 1.0, 1.0);
                this.showAlert(`Adrenalina #${this.adrenalineCount} registrada\nTimer resetado - pr√≥xima dose em 3 minutos`);

                this.updateDisplay();
            },

            changeMassager() {
                if (!this.massageActive) {
                    this.massageActive = true;
                }

                this.massageChangeCount++;
                this.massageChangeTime = 0;
                this.lastMassageAlert = -999;

                document.getElementById('massageCount').textContent =
                    `${this.massageChangeCount} troca${this.massageChangeCount > 1 ? 's' : ''}`;

                document.querySelector('#massageCard button').textContent = 'Registrar troca';

                voiceSystem.speak('Massagista trocado', 1.0, 1.0);
                this.showAlert(`Troca de massagista #${this.massageChangeCount}\nTimer resetado - pr√≥xima troca em 2 minutos`);

                this.updateDisplay();
            },

            registerShock() {
                const interval = this.shocks.length === 0
                    ? 0
                    : this.totalTime - this.lastShockTime;

                const shock = {
                    number: this.shocks.length + 1,
                    timestamp: this.totalTime,
                    interval: interval
                };

                this.shocks.push(shock);
                this.lastShockTime = this.totalTime;
                this.renderShocks();

                voiceSystem.speak('Choque aplicado', 1.0, 1.0);
                this.showAlert(
                    `Choque #${shock.number} registrado\nTempo: ${this.formatTime(shock.timestamp)}`
                );
            },

            renderShocks() {
                const list = document.getElementById('shockList');
                if (this.shocks.length === 0) {
                    list.innerHTML = '<div class="shocks-empty">Nenhum choque registrado</div>';
                    return;
                }

                list.innerHTML = this.shocks.map(shock => `
                    <div class="shock-item">
                        <div style="font-size:20px;">‚ö°</div>
                        <div class="shock-main">
                            <div class="shock-title">Choque #${shock.number}</div>
                            <div>Tempo: ${this.formatTime(shock.timestamp)}</div>
                        </div>
                        <div class="shock-interval">
                            ${shock.interval === 0
                                ? 'Inicial'
                                : '+' + this.formatTime(shock.interval)}
                        </div>
                    </div>
                `).join('');
            },

            showAlert(message) {
                document.getElementById('alertMessage').textContent = message;
                document.getElementById('alertOverlay').style.display = 'flex';
            },

            closeAlert() {
                document.getElementById('alertOverlay').style.display = 'none';
            },

            toggleAudio() {
                const enabled = voiceSystem.toggle();
                document.getElementById('audioEnabled').checked = enabled;
            },

            testVoice() {
                voiceSystem.speak('Teste de voz. Checar ritmo, trocar massagista. Aplicar adrenalina.', 0.9, 1.0);
            }
        };

        // Inicializa
        window.addEventListener('load', () => {
            voiceSystem.init();
            app.updateDisplay();
            app.renderShocks();
        });
    </script>
</body>
</html>
